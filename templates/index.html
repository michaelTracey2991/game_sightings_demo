<!--
index.html (view sightings)
Page for viewing all the sightings in DB
Purpose: List all sightings, filter/sort, preview photos, and show them on a Leaflet map.
Step 1: Escape values in onclick with |tojson for safety
Step 2: Fallback color for the marker swatch in the table
Step 3: Flash messages block to display Flask `flash(...)` calls
Step 4: CSRF in per-row delete from; uses {{ csrf_token() }}
Step 5: Awesome Markers is optional can remove it if needed
-->
<!DOCTYPE html>
<html>
<head>
  <title>Game Tracker</title>

  <!-- Style sheet styles link -->
  <link rel="stylesheet" href="/static/style.css">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Awesome Markers (for map pin) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.css">
  <!-- Tiny label style for sighting names -->
  <style>
    .sighting-label {
      background: transparent;
      border: none;
      box-shadow: none;
      color: #111;
      font-size: 11px;
      font-weight: 600;
      text-shadow: 0 1px 0 rgba(255,255,255,.7);
      padding: 0 2px;
      pointer-events: none;
      opacity: 0; /* hidden by default */
      transition: opacity .12s ease-in-out;
    }
    /* when the map has this class, show labels */
    .labels-on .leaflet-tooltip.sighting-label {
      opacity: 1;
    }
  </style>


  <!-- Awesome Markers (if you later use it for icons) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.css">
</head>
<body>

<!-- Simple nav back home -->
<p><a href="{{ url_for('home') }}">‚Üê Back to Main Page</a></p>

<!-- Page Heading -->
<h1>Sightings Log</h1>

<!-- Link to the add-sighting form - Click to Add New Sighting -->
<div class="header-actions">
  <a class="btn btn--sm btn--accent" href="{{ url_for('add_sighting') }}"> + Add New Sighting</a>
</div>

<!-- FLASH MESSAGES (shows success/error toasts) -->
{% with msgs = get_flashed_messages(with_categories=true) %}
  {% if msgs %}
    <ul class="flashes">
      {% for category, msg in msgs %}
        <li class="flash {{ category }}">{{ msg }}</li>  {# <-- fix here #}
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

<!-- FILTER + SORT FORM (GET) to narrow results in the table/map -->
<form method="GET" action="{{ url_for('view_sightings') }}">
  <label for="animal">Filter by Animal</label>
  <select name="animal">
    <option value="">-- All Animals --</option>
    {% for animal in unique_animals %}
      <option value="{{ animal }}" {% if animal_filter == animal %}selected{% endif %}>{{ animal }}</option>
    {% endfor %}
  </select>

  <label for="sort">Sort by Date:</label>
  <select name="sort">
    <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Newest First</option>
    <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Oldest First</option>
  </select>

  <button type="submit">Apply</button>
</form>

<!-- TABLE OF SIGHTINGS
      step 1: safe onlclick args via |tojson
      step 2: fallback color for the color swatch
      step 3: per-row delete with csrf token -->
<table border="1">
  <thead>
    <tr>
      <th>Animal</th>
      <th>Date/Time</th>
      <th>Weather</th>
      <th>Wind</th>
      <th>Wind Speed</th>
      <th>Wind Direction</th>
      <th>Humidity</th>
      <th>Temperature</th>
      <th>Location</th>
      <th>Notes</th>
      <th>Marker</th>
      <th>Photo</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
  {% for sighting in sightings %}
    <tr>
      <td>{{ sighting.animal.name if sighting.animal else '' }}</td> <!-- <<< CHANGED -->
      <td>{{ sighting.date_time.strftime('%Y-%m-%d %H:%M') if sighting.date_time else '' }}</td> <!-- <<< CHANGED -->
      <td>{{ sighting.weather }}</td>
      <td>{{ sighting.wind }}</td>
      <td>{{ sighting.wind_speed }}</td>
      <td>{{ sighting.wind_direction }}</td>
      <td>{{ sighting.humidity }}</td>
      <td>{{ sighting.temperature }}</td>
      <td>{{ sighting.location }}</td>
      <td>{{ sighting.notes }}</td>
      <td>
        <!-- Step 2: Fallback color '#3388ff' if marker_color is empty -->
        <div style="width:20px;height:20px;background-color:{{ sighting.marker_color or '#3388ff' }};border:1px solid #333;"></div>
      </td>
      <td>
        {% if sighting.photo_filename %}
          <!-- Step 1: Use |tojson to safely pass values to onlick -->
          <img
            src="{{ url_for('static', filename='uploads/' ~ sighting.photo_filename) }}"
            alt="Photo of {{ sighting.animal.name if sighting.animal else 'sighting' }}"
            class="photo-thumb"
            width="25"
            onclick="openModal(
              {{ url_for('static', filename='uploads/' ~ sighting.photo_filename)|tojson }},
              {{ (sighting.animal.name if sighting.animal else '')|tojson }},
              {{ (sighting.date_time.strftime('%Y-%m-%d %H:%M') if sighting.date_time else '')|tojson }}
            )">
        {% else %}
          No Photo
        {% endif %}
      </td>
      <td class="actions">
        <a class="btn btn--sm" href="{{ url_for('view_sighting', id=sighting.id) }}">View</a>
        <form method="POST"
              action="{{ url_for('delete_sighting', id=sighting.id) }}"
              style="display:inline; margin-left:6px;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="btn btn--sm btn--danger"
                  type="submit"
                  onclick="return confirm('Delete this sighting?')">
                  Delete
                </button>
              </form>
            </td>
          </tr>
  {% endfor %}
  </tbody>
</table>

<!-- MAP OF SIGHTINGS (leaflet) ============================================ -->
<h2>Map of Sightings</h2>
<div id="map" style="height: 400px;"></div>

<!-- Leaflet JS must be before Awesome Markers JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script> <!-- <<< CHANGED: order -->

<!-- STEP 5: Awesome Markers JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.js"></script>

<script>
    // Data from Flask
    const sightings = {{ sightings_json|tojson }};

    // Map setup
    const map = L.map('map').setView([45, -93], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const LABEL_ZOOM = 13; // show labels at this zoom and above

    sightings.forEach(s => {
      const lat = parseFloat(s.lat);
      const lng = parseFloat(s.lng);
      if (isNaN(lat) || isNaN(lng)) return;

      const markerColor = s.marker_color || '#2e7d32';
      const label = s.sighting_name || ''; // <<-- uses your sighting name
      const popupHtml = `
        <strong>${s.animal ?? ''}</strong><br>
        ${s.date_time ?? ''}${label ? `<br><em>${label}</em>` : ''}
        `;

      const m = L.circleMarker([lat, lng], {
        radius: 10,
        fillColor: markerColor,
        color: markerColor,
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      }).addTo(map).bindPopup(popupHtml);

      // Bind a tooltip (small caption). We'll open/close it based on zoom.
      if (label) {
        m.bindTooltip(label, {
          permanent: true,
          direction: 'right',
          offset: [10, 0],
          className: 'sighting-label',
        });
      }
    });

    // Toggle a class on the map container instead of opening/closing tooltips
    function updateLabelVisibility() {
      const show= map.getZoom() >= LABEL_ZOOM;
      map.getContainer().classList.toggle('labels-on', show);
    }

    updateLabelVisibility();
    map.on('zoomend', updateLabelVisibility);
</script>

<!-- PHOTO MODAL (click thumbnail -> show full image + details)  -->
<div id="photoModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <img id="modalImage" src="" alt="Full Image">
    <p id="modalDetails"></p>
  </div>
</div>

<!-- Modal JS -->
<script>
  // Open modal with image + details (animal, date/time)
  function openModal(imageUrl, animal, dateTime) {
    document.getElementById('modalImage').src = imageUrl;
    document.getElementById('modalDetails').textContent = `${animal} - ${dateTime}`;
    document.getElementById('photoModal').style.display = 'block';
  }

  // Close modal
  function closeModal() {
    document.getElementById('photoModal').style.display = 'none';
  }

  // Close when clicking outside modal
  window.onclick = function(event) {
    const modal = document.getElementById('photoModal');
    if (event.target === modal) {
      modal.style.display = "none";
    }
  };
</script>

</body>
</html>