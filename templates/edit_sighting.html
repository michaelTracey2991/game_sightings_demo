<!-- edit_sighting.html -->
<!DOCTYPE html>
<html>
<head>
  <title>Edit Sighting</title>

  <!-- CHANGED: match global stylesheet path -->
  <link rel="stylesheet" href="/static/style.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* keep it similar to add.html */
    .content-wrapper { display:flex; align-items:flex-start; justify-content:space-between; padding:40px; gap:40px; }
    .form-section { flex:2; min-width:300px; max-width:600px; }
    .map-section { flex:1; position:sticky; top:120px; align-self:flex-start; }
    #map { width:100%; height:400px; border:1px solid #ccc; border-radius:8px; margin-top:10px; }
    .errors { color:red; font-size:.9em; list-style:none; padding:0; margin:0 0 10px; }
    .form-row { margin:10px 0; display:flex; flex-direction:column; gap:6px; }

    /* small colored dot marker */
    .pin-dot { width:18px; height:18px; border-radius:50%; border:2px solid #fff; box-shadow:0 1px 4px rgba(0,0,0,.35); display:block; }
    /* keep map action buttons tidy */
    .map-actions .btn { padding:6px 10px; }
  </style>
</head>
<body>

<nav class="back-links">
  <a href="{{ url_for('view_sightings') }}">← Back to All Sightings</a>
  {% if request.referrer %}
    <a href="{{ request.referrer }}">← Back to Previous Page</a>
  {% endif %}
</nav>

<h1 style="text-align:center; padding-top:10px;">Edit Sighting</h1>

{% with msgs = get_flashed_messages(with_categories=true) %}
  {% if msgs %}
    <ul class="errors">
      {% for category, msg in msgs %}
        <li>{{ msg }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

<form method="POST" enctype="multipart/form-data">
  {{ form.hidden_tag() }}

  <div class="content-wrapper">

    <!-- LEFT: form -->
    <section class="form-section">

      <!-- CHANGED: add sighting_name -->
      <div class="form-row">
        <label for="sighting_name">{{ form.sighting_name.label }}</label>
        {{ form.sighting_name(id="sighting_name", placeholder="e.g., Ridge 7 Buck") }}
      </div>

      <!-- CHANGED: render the dynamic animal select from the form (route sets choices) -->
      <div class="form-row">
        <label for="animal">{{ form.animal.label }}</label>
        {{ form.animal(id="animal") }}
        {% if form.animal.errors %}
          <ul class="errors">{% for e in form.animal.errors %}<li>{{ e }}</li>{% endfor %}</ul>
        {% endif %}
      </div>

      <div class="form-row">
        <label for="date_time">{{ form.date_time.label }}</label>
        {{ form.date_time(id="date_time") }}
      </div>

      <div class="form-row">
        <label for="weather">{{ form.weather.label }}</label>
        {{ form.weather(id="weather", list="weather_options", placeholder="e.g., Partly Cloudy") }}
        <datalist id="weather_options">
          <option value="Clear"><option value="Sunny"><option value="Partly Cloudy">
          <option value="Mostly Cloudy"><option value="Overcast"><option value="Drizzle">
          <option value="Rain"><option value="Thunderstorm"><option value="Snow">
          <option value="Fog"><option value="Haze"><option value="Windy">
        </datalist>
      </div>

      <div class="form-row">
        <label for="wind">{{ form.wind.label }}</label>
        {{ form.wind(id="wind", placeholder="e.g., Breezy") }}
      </div>

      <div class="form-row">
        <label for="wind_speed">{{ form.wind_speed.label }}</label>
        {{ form.wind_speed(id="wind_speed") }}
      </div>

      <div class="form-row">
        <label for="wind_direction">{{ form.wind_direction.label }}</label>
        {{ form.wind_direction(id="wind_direction", list="dirOptions", placeholder="e.g., NW") }}
        <datalist id="dirOptions">
          <option value="N"><option value="NE"><option value="E">
          <option value="SE"><option value="S"><option value="SW">
          <option value="W"><option value="NW">
        </datalist>
      </div>

      <div class="form-row">
        <label for="humidity">{{ form.humidity.label }}</label>
        {{ form.humidity(id="humidity") }}
      </div>

      <div class="form-row">
        <label for="temperature">{{ form.temperature.label }}</label>
        {{ form.temperature(id="temperature", list="tempOptions", placeholder="e.g., 45") }}
        <datalist id="tempOptions">
          {% for t in range(-30, 101, 5) %}<option value="{{ t }}">{% endfor %}
        </datalist>
      </div>

      <div class="form-row">
        <label for="notes">{{ form.notes.label }}</label>
        {{ form.notes(id="notes", rows="3", placeholder="Anything notable?") }}
      </div>

      <div class="form-row">
        <label for="marker_color">{{ form.marker_color.label }}</label>
        {{ form.marker_color(id="marker_color") }}
      </div>

      <!-- hidden lat/lng -->
      {{ form.lat(id="lat") }}
      {{ form.lng(id="lng") }}

      <div class="form-row">
        <label for="photo">{{ form.photo.label }}</label>
        {{ form.photo(id="photo", accept=".jpg,.jpeg,.png,.gif", onchange="previewPhoto(this)") }}
        <div style="margin-top:8px;">
          <img id="photoPreview"
               src="{{ url_for('static', filename='uploads/' ~ sighting.photo_filename) if sighting.photo_filename else '' }}"
               style="display:{{ 'block' if sighting.photo_filename else 'none' }}; max-width:200px; border:1px solid #ccc; border-radius:4px;">
        </div>
      </div>

      <div class="form-actions">
        <button class="btn btn--sm btn--primary" type="submit">Save</button>
        <a class="btn btn--sm btn--ghost" href="{{ url_for('view_sightings') }}">Cancel</a>
      </div>

    </section>

    <!-- RIGHT: map & location -->
    <aside class="map-section">
      <h3>Edit Location on Map</h3>
      <p class="muted" id="mapHint">Click “Choose on map”, then click once to drop/move the pin. Or drag the pin.</p>

      <div class="map-actions" style="margin:6px 0; display:flex; gap:8px; flex-wrap:wrap;">
        <button type="button" class="btn" id="btnChoose">Choose on Map</button>
        <button type="button" class="btn" id="btnLocate">Use My Location</button>
        <button type="button" class="btn" id="btnClear">Clear Pin</button>
      </div>

      <div class="form-row">
        <label for="location">{{ form.location.label }}</label>
        {{ form.location(id="location", placeholder="Optional description (e.g., 'north meadow')") }}
      </div>

      <div id="map"></div>

      <div class="form-row" style="margin-top:8px;">
        <small>Lat: <span id="latDisplay">{{ form.lat.data or '' }}</span> |
               Lng: <span id="lngDisplay">{{ form.lng.data or '' }}</span></small>
      </div>
    </aside>

  </div><!-- /.content-wrapper -->
</form>

<script>
  // ---------- Reusable helpers (same style as add.html) ----------
  function previewPhoto(input){
    const img = document.getElementById('photoPreview');
    if (input.files && input.files[0]) {
      img.src = URL.createObjectURL(input.files[0]);
      img.style.display = 'block';
    } else {
      img.src = '';
      img.style.display = 'none';
    }
  }

  const latInput = document.getElementById('lat');
  const lngInput = document.getElementById('lng');
  const latDisplay = document.getElementById('latDisplay');
  const lngDisplay = document.getElementById('lngDisplay');
  const colorInput = document.getElementById('marker_color');
  const locationInput = document.getElementById('location');

  const existingLat = parseFloat(latInput.value);
  const existingLng = parseFloat(lngInput.value);
  const startLat  = !isNaN(existingLat) ? existingLat : 45.0;
  const startLng  = !isNaN(existingLng) ? existingLng : -93.0;
  const startZoom = (!isNaN(existingLat) && !isNaN(existingLng)) ? 13 : 6;

  const map = L.map('map').setView([startLat, startLng], startZoom);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  let marker = null;
  let chooseMode = false;

  function getMarkerColor(){
    return (colorInput && colorInput.value) ? colorInput.value : '#2e7d32';
  }

  function makeDotIcon(color){
    // CHANGED: proper template literal
    return L.divIcon({
      className: '',
      html: `<span class="pin-dot" style="background:${color}"></span>`,
      iconSize: [18,18],
      iconAnchor: [9,9]
    });
  }

  function updateInputs(lat, lng){
    latInput.value = lat.toFixed(6);
    lngInput.value = lng.toFixed(6);
    latDisplay.textContent = latInput.value;
    lngDisplay.textContent = lngInput.value;
    // keep the free-text location minimally updated if empty
    if (!locationInput.value) {
      locationInput.value = `${latInput.value}, ${lngInput.value}`;
    }
  }

  function ensureMarker(lat, lng){
    const icon = makeDotIcon(getMarkerColor());
    if (!marker) {
      marker = L.marker([lat, lng], { draggable:true, icon }).addTo(map);
      marker.on('drag', e => {
        const p = e.target.getLatLng(); updateInputs(p.lat, p.lng);
      });
      marker.on('dragend', e => {
        const p = e.target.getLatLng(); updateInputs(p.lat, p.lng);
      });
    } else {
      marker.setLatLng([lat, lng]);
      marker.setIcon(icon);
    }
  }

  function setLatLng(lat, lng){
    updateInputs(lat, lng);
    ensureMarker(lat, lng);
  }

  if (!isNaN(existingLat) && !isNaN(existingLng)) {
    ensureMarker(existingLat, existingLng);
  }

  // color live update
  if (colorInput) {
    colorInput.addEventListener('input', () => {
      if (marker) marker.setIcon(makeDotIcon(getMarkerColor()));
    });
  }

  // choose mode click
  map.on('click', (e) => {
    if (!chooseMode) return;
    setLatLng(e.latlng.lat, e.latlng.lng);
    chooseMode = false;
    document.getElementById('mapHint').textContent = 'Click “Choose on map” to pick another spot.';
  });

  // buttons
  document.getElementById('btnChoose').addEventListener('click', () => {
    chooseMode = true;
    document.getElementById('mapHint').textContent = 'Choose mode ON — click the map once to move the pin.';
  });

  document.getElementById('btnLocate').addEventListener('click', () => {
    if (!navigator.geolocation) { alert('Geolocation is not supported by your browser.'); return; }
    navigator.geolocation.getCurrentPosition(
      pos => {
        const { latitude, longitude } = pos.coords;
        setLatLng(latitude, longitude);
        map.setView([latitude, longitude], 14);
      },
      err => alert('Could not get your location: ' + err.message),
      { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
    );
  });

  document.getElementById('btnClear').addEventListener('click', () => {
    if (marker) { map.removeLayer(marker); marker = null; }
    latInput.value = ''; lngInput.value = '';
    latDisplay.textContent = ''; lngDisplay.textContent = '';
    // keep location text but you could also clear it:
    // locationInput.value = '';
  });
</script>

</body>
</html>