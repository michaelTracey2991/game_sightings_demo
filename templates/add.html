<!--
add.html (Add new sighting)
Template for the "Add New Sighting" page.
Provides a user-friendly form interface to input details about wildlife sightings,
including animal type, weather conditions, location selection via map interaction,
and optional photo upload.
Uses Flask-WTF form rendering along with JavaScript powered map integration for pin placement.
-->

<!DOCTYPE html>
<html>
<head>
    <title>Add Sighting • Game Tracker</title>
    <link rel="stylesheet" href="/static/style.css">

    <!-- Leaflet CSS for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        .content-wrapper {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 40px;
            gap: 40px;
        }
        .form-section {
            flex: 2;
            min-width: 300px;
            max-width: 600px;
        }
        .map-section {
            flex: 1;
            position: sticky;
            top: 120px;
            align-self: flex-start;
        }
        #map {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-top: 20px;
        }
        .errors {
            color: red;
            font-size: 0.9em;
            list-style: none;
            padding: 0;
            margin: 0 0 10px;
        }
        .muted { color: #666; font-size: 0.9em; }
        .form-row { margin: 10px 0; display: flex; flex-direction: column; gap: 6px; }
        .btn { padding: 8px 14px; border: 1px solid #888; border-radius: 6px; background: #f5f5f5; cursor: pointer; }
        .btn:hover { background: #eee; }

        @media (max-width: 900px) {
         .content-wrapper { flex-direction: column; }
        .map-section { position: static; top: auto; }
    </style>
</head>
<body>

    <!-- Back nav -->
    <p><a href="{{ url_for('view_sightings') }}">← Back to Sightings</a></p>

    <!-- Title -->
    <h1 style="text-align: center; padding-top: 40px;">Add New Sighting</h1>

    <!-- STEP 0: Flash Messages (show server-side notices) -->
    {% with msgs = get_flashed_messages(with_categories=true) %}
        {% if msgs %}
            <ul class="flashes">
                {% for category, msg in msgs %}
                    <li class="flash {{ category }}">{{ msg }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

<!-- Two-column layout: form(left) + sticky map(right) ===================== -->
<div class="content-wrapper">

    <!-- ===== Left: the form ===== -->
    <section class="form-section">
      <!-- STEP 1: POST + multipart for uploads; hidden_tag() adds CSRF -->
      <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <!-- Category → Animal (dynamic) -->
        <div class="form-row">
          <label for="animal_category">{{ form.animal_category.label }}</label>
          {{ form.animal_category(id="animal_category") }}
          {% if form.animal_category.errors %}
            <ul class="errors">{% for e in form.animal_category.errors %}<li>{{ e }}</li>{% endfor %}</ul>
          {% endif %}
        </div>

        <div class="form-row">
          <label for="animal">{{ form.animal.label }}</label>
          {{ form.animal(id="animal") }}
          {% if form.animal.errors %}
            <ul class="errors">{% for e in form.animal.errors %}<li>{{ e }}</li>{% endfor %}</ul>
          {% endif %}
        </div>

        <!-- When -->
        <div class="form-row">
          <label for="date_time">{{ form.date_time.label }}</label>
          {{ form.date_time(id="date_time") }}
        </div>

        <!-- Weather bits -->
        <div class="form-row">
          <label for="weather">{{ form.weather.label }}</label>
          {{ form.weather(id="weather", placeholder="e.g., clear") }}
        </div>

        <div class="form-row">
          <label for="wind">{{ form.wind.label }}</label>
          {{ form.wind(id="wind", placeholder="e.g., light breeze") }}
        </div>

        <div class="form-row">
          <label for="wind_speed">{{ form.wind_speed.label }}</label>
          {{ form.wind_speed(id="wind_speed") }}
        </div>

        <div class="form-row">
          <label for="wind_direction">{{ form.wind_direction.label }}</label>
          {{ form.wind_direction(id="wind_direction", placeholder="e.g., NW") }}
        </div>

        <div class="form-row">
          <label for="humidity">{{ form.humidity.label }}</label>
          {{ form.humidity(id="humidity") }}
        </div>

        <div class="form-row">
          <label for="temperature">{{ form.temperature.label }}</label>
          {{ form.temperature(id="temperature", placeholder="e.g., 45°F") }}
        </div>

        <!-- Location text -->
        <div class="form-row">
          <label for="location">{{ form.location.label }}</label>
          {{ form.location(id="location", placeholder="Optional description (e.g., 'north meadow')") }}
        </div>

        <!-- Notes -->
        <div class="form-row">
          <label for="notes">{{ form.notes.label }}</label>
          {{ form.notes(id="notes", rows="3", placeholder="Anything notable?") }}
        </div>

        <!-- Marker color -->
        <div class="form-row">
          <label for="marker_color">{{ form.marker_color.label }}</label>
          {{ form.marker_color(id="marker_color") }}
        </div>

        <!-- Hidden lat/lng that the map updates -->
        {{ form.lat(id="lat") }}
        {{ form.lng(id="lng") }}

        <!-- Photo upload + preview -->
        <div class="form-row">
          <label for="photo">{{ form.photo.label }}</label>
          {{ form.photo(id="photo", accept=".jpg,.jpeg,.png,.gif") }}
          <div id="photoPreviewWrap" style="margin-top:8px;">
            <img id="photoPreview" alt="Photo preview" style="display:none; max-width:200px; border:1px solid #ccc; border-radius:4px;">
          </div>
        </div>

        <!-- Submit -->
        <div class="form-row">
          {{ form.submit(class_="btn") }}
        </div>
      </form>
    </section>

    <!-- ===== Right: sticky map & live coordinates ===== -->
    <aside class="map-section">
      <h3>Pick Location on Map</h3>
      <p class="muted">Click the map to set latitude/longitude. Click again to move the marker.</p>

      <div id="map"></div>

      <div class="form-row" style="margin-top:10px;">
        <small>Lat: <span id="latDisplay">{{ form.lat.data or '' }}</span> |
        Lng: <span id="lngDisplay">{{ form.lng.data or '' }}</span></small>
      </div>
    </aside>

  </div><!-- /.content-wrapper -->

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // =========================================================
    // STEP 2: Category → animal linkage
    // - Populate the "Animal" select based on selected category
    // =========================================================
    const ANIMAL_CHOICES = {{ animal_choices|tojson }};
    const categorySelect = document.getElementById('animal_category');
    const animalSelect   = document.getElementById('animal');

    function renderAnimalsFor(cat, selectedValue = "") {
      const animals = ANIMAL_CHOICES[cat] || [];
      animalSelect.innerHTML = "";
      const placeholder = new Option("Select an animal", "", true, false);
      placeholder.disabled = true;
      animalSelect.add(placeholder);
      animals.forEach(name => {
        const opt = new Option(name, name, false, name === selectedValue);
        animalSelect.add(opt);
      });
    }

    categorySelect.addEventListener('change', e => {
      renderAnimalsFor(e.target.value);
    });

    // On load: if category already chosen (after validation error), restore animals
    (function bootstrapAnimalSelect() {
      const initialCat = categorySelect.value || "";
      const initialAnimal = {{ (form.animal.data or '')|tojson }};
      if (initialCat) renderAnimalsFor(initialCat, initialAnimal);
    })();

    // =========================================================
    // STEP 3: Leaflet map to set coordinates
    // - Writes to hidden inputs inside the form
    // - Map is outside the form (right column), which is fine:
    //   we update by element IDs.
    // =========================================================
    const latInput   = document.getElementById('lat');
    const lngInput   = document.getElementById('lng');
    const latDisplay = document.getElementById('latDisplay');
    const lngDisplay = document.getElementById('lngDisplay');

    const existingLat = parseFloat(latInput.value);
    const existingLng = parseFloat(lngInput.value);
    const startLat  = !isNaN(existingLat) ? existingLat : 45.0;
    const startLng  = !isNaN(existingLng) ? existingLng : -93.0;
    const startZoom = (!isNaN(existingLat) && !isNaN(existingLng)) ? 10 : 6;

    const map = L.map('map').setView([startLat, startLng], startZoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let marker = null;
    if (!isNaN(existingLat) && !isNaN(existingLng)) {
      marker = L.marker([existingLat, existingLng]).addTo(map);
    }

    function setLatLng(lat, lng) {
      latInput.value = lat.toFixed(6);
      lngInput.value = lng.toFixed(6);
      latDisplay.textContent = latInput.value;
      lngDisplay.textContent = lngInput.value;

      if (marker) marker.setLatLng([lat, lng]);
      else marker = L.marker([lat, lng]).addTo(map);
    }

    map.on('click', (e) => {
      setLatLng(e.latlng.lat, e.latlng.lng);
    });

    // =========================================================
    // STEP 4: Show preview for uploaded photo
    // =========================================================
    const photoInput   = document.getElementById('photo');
    const photoPreview = document.getElementById('photoPreview');

    photoInput.addEventListener('change', () => {
      const file = photoInput.files && photoInput.files[0];
      if (!file) {
        photoPreview.style.display = 'none';
        photoPreview.src = '';
        return;
      }
      const url = URL.createObjectURL(file);
      photoPreview.src = url;
      photoPreview.style.display = 'block';
    });
  </script>

</body>
</html>