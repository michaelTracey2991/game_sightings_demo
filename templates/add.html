<!--
add.html (Add new sighting)
Template for the "Add New Sighting" page.
Provides a user-friendly form interface to input details about wildlife sightings,
including animal type, weather conditions, location selection via map interaction,
and optional photo upload.
Uses Flask-WTF form rendering along with JavaScript powered map integration for pin placement.
-->

<!DOCTYPE html>
<html>
<head>
    <title>Add New Sighting</title>

    <!-- Return Button - view_sightings is index.html in app.py -->
    <a href="{{ url_for('home') }}">‚Üê Back to Main Page</a>

    <link rel="stylesheet" href="/static/style/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        .content-wrapper {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 40px;
            gap: 40px;
        }
        .form-section {
            flex: 2;
            min-width: 300px;
            max-width: 600px;
        }
        .map-section {
            flex: 1;
            position: sticky;
            top: 120px;
            align-self: flex-start;
        }
        #map {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-top: 20px;
        }
        .errors {
            color: red;
            font-size: 0.9em;
            list-style: none;
            padding: 0;
            margin: 0 0 10px;
        }
    </style>
</head>
<body>

<h1 style="text-align: center; padding-top: 40px;">Add New Sighting</h1>

<div class="content-wrapper">
    <div class="form-section">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="errors">
              {% for category, message in messages %}
                <li>{{ message }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        <form method="POST" enctype="multipart/form-data">
            {{ form.hidden_tag() }}

            <!-- Animal Dropdown -->
            <!-- Handles validation for errors -->
            <label for="animal_category">Animal Category:</label>
            <select name="{{ form.animal_category.name }}" id="animal_category" required>
                {% for value, label in form.animal_category.choices %}
                    <option value="{{ value }}" {% if form.animal_category.data == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            {% if form.animal_category.errors %}
                <ul class="errors">{% for error in form.animal_category.errors %}
                    <li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
            <br><br>
            <!-- Step 2: Animal (populated via JavaScript) -->
            <label for="animal">Animal:</label>
            <select name="{{ form.animal.name }}" id="animal" required>
                {% if form.animal.choices %}
                    {% for value, label in form.animal.choices %}
                        <option value="{{ value }}" {% if form.animal.data == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                {% else %}
                    <option value="">Select an animal category first</option>
                {% endif %}
            </select>
            {% if form.animal.errors %}
                <ul class="errors">{% for error in form.animal.errors %}
                <li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
            <br><br>

            <!-- Date/Time -->
            <label for="date_time">Date/Time:</label>
            {{ form.date_time(id="date_time") }}
            {% if form.date_time.errors %}
                <ul class="errors">{% for error in form.date_time.errors %}<li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
            <br><br>

            <!-- üå§Ô∏è Weather -->
            <label for="weather">Weather:</label>
            <input type="text" name="{{ form.weather.name }}" id="weather" list="weather_options" value="{{ form.weather.data or '' }}">
            <datalist id="weather_options">
                {% for w in ["Sunny", "Cloudy", "Partly Cloudy", "Rain", "Snow", "Foggy", "Hail", "Windy"] %}
                    <option value="{{ w }}">
                {% endfor %}
            </datalist>
            {% if form.weather.errors %}
                <ul class="errors">{% for error in form.weather.errors %}<li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
            <br><br>

            <!-- üí® Wind -->
            <label for="wind">Wind:</label>
            <input type="text" name="{{ form.wind.name }}" id="wind" list="wind_options" value="{{ form.wind.data or '' }}">
            <datalist id="wind_options">
                {% for w in ["Calm", "Light Breeze", "Moderate Breeze", "Strong Breeze", "Gusty", "Windy"] %}
                    <option value="{{ w }}">
                {% endfor %}
            </datalist>
            {% if form.wind.errors %}
                <ul class="errors">{% for error in form.wind.errors %}<li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
            <br><br>

            <!-- üß≠ Wind Direction -->
            <label for="wind_direction">Wind Direction:</label>
            <input type="text" name="{{ form.wind_direction.name }}" id="wind_direction" list="wind_direction_options" value="{{ form.wind_direction.data or '' }}">
            <datalist id="wind_direction_options">
                {% for direction in ["N", "NE", "E", "SE", "S", "SW", "W", "NW"] %}
                    <option value="{{ direction }}">
                {% endfor %}
            </datalist>
            {% if form.wind_direction.errors %}
                <ul class="errors">{% for error in form.wind_direction.errors %}<li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
            <br><br>

            <!-- üí® Wind Speed -->
            <label for="wind_speed">Wind Speed (mph):</label>
            {{ form.wind_speed() }}
            {% if form.wind_speed.errors %}
              <ul class="errors">{% for error in form.wind_speed.errors %}<li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
            <br><br>

            <!-- üíß Humidity -->
            <label for="humidity">Humidity (%):</label>
            {{ form.humidity() }}
            {% if form.humidity.errors %}
                <ul class="errors">{% for error in form.humidity.errors %}<li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
            <br><br>

            <!-- üå°Ô∏è Temperature -->
            <label for="temperature">Temperature (¬∞F):</label>
            <input type="text" name="{{ form.temperature.name }}" id="temperature" list="temperature_options" value="{{ form.temperature.data or '' }}">
            <datalist id="temperature_options">
                {% for t in range(-20, 121, 5) %}
                    <option value="{{ t }}¬∞F">
                {% endfor %}
            </datalist>
            {% if form.temperature.errors %}
                <ul class="errors">{% for error in form.temperature.errors %}<li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
            <br><br>

            <!-- Location -->
            <label for="location">Location:</label>
            {{ form.location(id="autocomplete") }}
            <button type="button" onclick="getCurrentLocation()">üìç Use My Location</button>
            <button type="button" onclick="enablePinDrop()">üìå Select on Map</button><br>
            {{ form.lat(id="lat") }}
            {{ form.lng(id="lng") }}
            {% if form.location.errors %}
                <ul class="errors">{% for error in form.location.errors %}<li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
            <br><br>

            <!-- Notes -->
            <label for="notes">Notes:</label>
            {{ form.notes(id="notes") }}
            {% if form.notes.errors %}
                <ul class="errors">{% for error in form.notes.errors %}<li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
            <br><br>

            <!-- Pin Color -->
            <label for="marker_color">Pin Color:</label>
            {{ form.marker_color(id="marker_color") }}
            {% if form.marker_color.errors %}
                <ul class="errors">{% for error in form.marker_color.errors %}<li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
            <br><br>

            <!-- Photo Upload -->
            <label for="photo">Upload Photo:</label>
            {{ form.photo(id="photo") }}
            {% if form.photo.errors %}
                <ul class="errors">{% for error in form.photo.errors %}<li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
            <br><br>

            <!-- Submit -->
            <br><br>
            <input type="submit" value="Save">
        </form>
        <br>

    </div>

    <div class="map-section">
        <div id="map"></div>
    </div>
</div>

<script>
    const map = L.map('map').setView([45.0, -93.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    let marker;
    let pinDropEnabled = false;

    map.on('click', function (e) {
        if (!pinDropEnabled) return;
        const { lat, lng } = e.latlng;
        document.getElementById("lat").value = lat;
        document.getElementById("lng").value = lng;
        document.getElementById("autocomplete").value = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'custom-icon',
                html: `<div style="background:${document.getElementById("marker_color").value};width:12px;height:12px;border-radius:50%;"></div>`
            })
        }).addTo(map);
    });

    document.getElementById("marker_color").addEventListener("input", function () {
        if (marker) {
            const lat = marker.getLatLng().lat;
            const lng = marker.getLatLng().lng;
            map.removeLayer(marker);
            marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-icon',
                    html: `<div style="background:${this.value};width:12px;height:12px;border-radius:50%;"></div>`
                })
            }).addTo(map);
        }
    });

    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                document.getElementById("lat").value = lat;
                document.getElementById("lng").value = lng;
                document.getElementById("autocomplete").value = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
                map.setView([lat, lng], 13);
                if (marker) map.removeLayer(marker);
                marker = L.marker([lat, lng]).addTo(map);
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    function enablePinDrop() {
        pinDropEnabled = true;
        alert("Click on the map to place your pin.");
    }

    // Prevent form submission via Enter key (except in textareas)
    document.querySelector("form").addEventListener("keydown", function (e) {
        if (e.key === "Enter" && e.target.tagName !== "TEXTAREA") {
            e.preventDefault();
        }
    });
</script>

<!-- Dynamically update Animal dropdown when an animal category is selected
    should go in add.html template -
 -->
<script>
    const animalChoices = {{ animal_choices|tojson|safe }};

  document.getElementById('animal_category').addEventListener('change', function () {
    const selectedCategory = this.value;
    const animalSelect = document.getElementById('animal');

    // Clear existing options
    animalSelect.innerHTML = '';

    // Add new options based on selected category
    if (animalChoices[selectedCategory]) {
      animalChoices[selectedCategory].forEach(function (animal) {
        const option = document.createElement('option');
        option.value = animal;
        option.text = animal;
        animalSelect.appendChild(option);
      });
    } else {
      const option = document.createElement('option');
      option.value = '';
      option.text = 'Select an animal category first';
      animalSelect.appendChild(option);
    }
  });
</script>

</body>
</html>