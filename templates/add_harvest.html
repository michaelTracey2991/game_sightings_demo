<!--
ADD_HARVEST.HTML
- Displays a form for users to log a new game harvest.
- Collects data such as animal type, date, weapon used, caliber or broadhead, and notes.
- Includes interactive Leaflet map for selecting shot and recovery locations.
- Allows users to upload a photo and choose a marker color for map pins.
- Data is submitted to the /add-harvest route and stored in the database.
-->
<!DOCTYPE html>
<html>
<head>
    <title>Add New Harvest</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        .content-wrapper {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 40px;
            gap: 40px;
        }
        .form-section {
            flex: 2;
            min-width: 300px;
            max-width: 600px;
        }
        .map-section {
            flex: 1;
            position: sticky;
            top: 120px;
            align-self: flex-start;
        }
        #map {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-top: 20px;
        }
        .errors {
            color: red;
            font-size: 0.9rem;
            list-style: none;
            padding: 0;
            margin: 0 0 10px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center;">Add New Harvest</h1>

    <div class="content-wrapper">
        <div class="form-section">
            <form method="POST" enctype="multipart/form-data">
                {{ form.hidden_tag() }}

                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <ul>
                        {% for category, message in messages %}
                            <li class="{{ category }}">{{ message }}</li>
                        {% endfor %}
                        </ul>
                    {% endif %}
                {% endwith %}

                <label for="animal">Animal:</label>
                {{ form.animal() }}
                {% if form.animal.errors %}
                    <ul class="errors">{% for error in form.animal.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                {% endif %}

                <br><br>

                <label for="date_time">Date & Time:</label>
                {{ form.date_time(type="datetime-local") }}
                {% if form.date_time.errors %}
                    <ul class="errors">{% for error in form.date_time.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                {% endif %}

                <br><br>

                <label for="weapon_select">Weapon Type:</label>
                {{ form.weapon_type(id="weapon_select") }}
                {% if form.weapon_type.errors %}
                    <ul class="errors">{% for error in form.weapon_type.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                {% endif %}

                <div id="other_weapon_div" class="hidden">
                    <label for="other_weapon_type">If Other:</label>
                    {{ form.other_weapon_type(disabled=True, class_="disabled") }}
                    {% if form.other_weapon_type.errors %}
                        <ul class="errors">{% for error in form.other_weapon_type.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                    {% endif %}
                </div>

                <br>

                <div id="caliber_section" class="hidden">
                    <label for="caliber_select">Caliber / Gauge:</label>
                    <select id="caliber_select" name="caliber" disabled class="disabled">
                        <option value="">Select caliber/gauge</option>
                    </select>
                    {% if form.caliber.errors %}
                        <ul class="errors">{% for error in form.caliber.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                    {% endif %}
                </div>

                <div id="other_caliber_div" class="hidden">
                    <label for="other_caliber">If Other:</label>
                    {{ form.other_caliber(disabled=True, class_="disabled") }}
                    {% if form.other_caliber.errors %}
                        <ul class="errors">{% for error in form.other_caliber.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                    {% endif %}
                </div>

                <div id="broadhead_section" class="hidden">
                    <label for="broadhead_select">Broadhead Type:</label>
                    <select id="broadhead_select" name="broadhead" disabled class="disabled">
                        <option value="">Select broadhead</option>
                        <option value="Fixed">Fixed</option>
                        <option value="Mechanical">Mechanical</option>
                        <option value="Hybrid">Hybrid</option>
                        <option value="Other">Other</option>
                    </select>
                    {% if form.broadhead.errors %}
                        <ul class="errors">{% for error in form.broadhead.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                    {% endif %}
                </div>

                <div id="other_broadhead_div" class="hidden">
                    <label for="other_broadhead">If Other:</label>
                    {{ form.other_broadhead(disabled=True, class_="disabled") }}
                    {% if form.other_broadhead.errors %}
                        <ul class="errors">{% for error in form.other_broadhead.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                    {% endif %}
                </div>

                <!-- Weather Dropdown -->
                <label for="weather_select">Weather:</label>
                <select id="weather_select" name="weather">
                    <option value="">Select Weather</option>
                    <option value="Clear">Clear</option>
                    <option value="Cloudy">Cloudy</option>
                    <option value="Rain">Rain</option>
                    <option value="Snow">Snow</option>
                    <option value="Fog">Fog</option>
                    <option value="windy">Windy</option>
                </select>
                <br>
                <br>

                <!-- Wind Speed Dropdown -->
                <label for="wind_speed_select">Wind Speed (mph):</label>
                <select id="wind_speed_select" name="wind_speed">
                    <option value="">Select wind speed</option>
                    <option value="Calm (0-1)">Calm (0-1)</option>
                    <option value="Light Air (1-3)">Light Air (1-3)</option>
                    <option value="Light Breeze (4-7)">Light Breeze (4-7)</option>
                    <option value="Gentle Breeze (8-12)">Gentle Breeze (8-12)</option>
                    <option value="Moderate Breeze (13-18)">Moderate Breeze (13-18)</option>
                    <option value="Fresh Breeze (19-24)">Fresh Breeze (19-24)</option>
                    <option value="Strong Breeze (25-31)">Strong Breeze (25-31)</option>
                </select>
                <br>
                <br>

                <!-- Wind Direction Dropdown -->

                <h3>Map - Set Locations</h3>
                <button type="button" id="btnShot">Set Shot Location</button>
                <button type="button" id="btnRecovery">Set Recovery Location</button>
                <div id="map"></div>
                <br>

                {{ form.shot_lat() }} {{ form.shot_lng() }}
                {{ form.recovery_lat() }} {{ form.recovery_lng() }}
                <br>

                <label for="distance_input">Distance Traveled (yards):</label>
                {{ form.distance_traveled(readonly="readonly", id="distance_input", style="background:#f0f0f0; border:none; width:100px;") }}
                {% if form.distance_traveled.errors %}
                    <ul class="errors">{% for error in form.distance_traveled.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                {% endif %}

                <br>
                <br>

                <label for="marker_color_input">Marker Color:</label>
                {{ form.marker_color(type="color", id="marker_color_input") }}
                <br>
                <br>

                <label for="notes">Notes:</label>
                {{ form.notes(rows=4, cols=50, id="notes") }}
                {% if form.notes.errors %}
                    <ul class="errors">{% for error in form.notes.errors %}<li>{{ error }}</li>{% endfor %}</ul>
                {% endif %}
                <br>
                <br>

                <label for="photo">Upload Photo:</label>
                {{ form.photo() }}
                <br>
                <br>

                <button type="submit">Submit Harvest</button>
                <br><br>
                <a href="{{ url_for('view_harvests') }}">Back to All Harvests</a>
            </form>
        </div>

        <div class="map-section"></div>
    </div>

    <!-- Leaflet & Interactivity -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
    const weaponSelect = document.getElementById("weapon_select");
    const caliberSelect = document.getElementById("caliber_select");
    const broadheadSelect = document.getElementById("broadhead_select");

    const caliberSection = document.getElementById("caliber_section");
    const broadheadSection = document.getElementById("broadhead_section");

    const otherWeaponDiv = document.getElementById("other_weapon_div");
    const otherCaliberDiv = document.getElementById("other_caliber_div");
    const otherBroadheadDiv = document.getElementById("other_broadhead_div");

    const weaponOptions = {
        "Rifle": [".223", ".243", ".270", ".30-06", ".308", "7mm", "Other"],
        "Shotgun": ["12 gauge", "20 gauge", "16 gauge", "10 gauge", "Other"],
        "Compound Bow": ["N/A"],
        "Recurve Bow": ["N/A"],
        "Longbow": ["N/A"],
        "Crossbow": ["N/A"]
    };

    const bowTypes = ["Compound Bow", "Recurve Bow", "Longbow", "Crossbow"];

    weaponSelect.addEventListener("change", () => {
        const selected = weaponSelect.value;
        const isBow = bowTypes.includes(selected);

        // Caliber logic
        if (isBow) {
            caliberSection.classList.add("hidden");
            caliberSelect.disabled = true;
            caliberSelect.classList.add("disabled");
        } else {
            caliberSection.classList.remove("hidden");
            caliberSelect.disabled = false;
            caliberSelect.classList.remove("disabled");
            caliberSelect.innerHTML = '<option value="">Select caliber/gauge</option>';
            (weaponOptions[selected] || []).forEach(opt => {
                const o = document.createElement("option");
                o.value = opt;
                o.textContent = opt;
                caliberSelect.appendChild(o);
            });
        }

        // Broadhead logic
        if (isBow) {
            broadheadSection.classList.remove("hidden");
            broadheadSelect.disabled = false;
            broadheadSelect.classList.remove("disabled");
        } else {
            broadheadSection.classList.add("hidden");
            broadheadSelect.disabled = true;
            broadheadSelect.classList.add("disabled");
        }

        // Other weapon field
        if (selected === "Other") {
            otherWeaponDiv.classList.remove("hidden");
            otherWeaponDiv.querySelector("input").disabled = false;
            otherWeaponDiv.querySelector("input").classList.remove("disabled");
        } else {
            otherWeaponDiv.classList.add("hidden");
            otherWeaponDiv.querySelector("input").disabled = true;
            otherWeaponDiv.querySelector("input").classList.add("disabled");
        }
    });

    caliberSelect.addEventListener("change", () => {
        const showOther = caliberSelect.value === "Other";
        otherCaliberDiv.classList.toggle("hidden", !showOther);
        otherCaliberDiv.querySelector("input").disabled = !showOther;
        otherCaliberDiv.querySelector("input").classList.toggle("disabled", !showOther);
    });

    broadheadSelect.addEventListener("change", () => {
        const showOther = broadheadSelect.value === "Other";
        otherBroadheadDiv.classList.toggle("hidden", !showOther);
        otherBroadheadDiv.querySelector("input").disabled = !showOther;
        otherBroadheadDiv.querySelector("input").classList.toggle("disabled", !showOther);
    });

    // MAP LOGIC
    const map = L.map('map').setView([45, -93], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let shotMarker, recMarker;
    let setting = null;

    document.getElementById('btnShot').onclick = () => setting = "shot";
    document.getElementById('btnRecovery').onclick = () => setting = "recovery";

    map.on('click', e => {
        if (!setting) return;
        const { lat, lng } = e.latlng;
        const color = document.getElementById("marker_color_input").value || "#3388ff";
        const icon = L.divIcon({
            className: 'custom-div-icon',
            html: `<div style="background-color:${color}; width:16px; height:16px; border-radius:50%; border:2px solid white;"></div>`,
            iconSize: [16, 16],
            iconAnchor: [8, 8]
        });

        if (setting === "shot") {
            if (shotMarker) map.removeLayer(shotMarker);
            shotMarker = L.marker(e.latlng, { icon, draggable: true }).addTo(map).bindPopup("Shot").openPopup();
            document.querySelector('[name="shot_lat"]').value = lat;
            document.querySelector('[name="shot_lng"]').value = lng;
            shotMarker.on('dragend', () => updateLocation(shotMarker, "shot"));
        }

        if (setting === "recovery") {
            if (recMarker) map.removeLayer(recMarker);
            recMarker = L.marker(e.latlng, { icon, draggable: true }).addTo(map).bindPopup("Recovery").openPopup();
            document.querySelector('[name="recovery_lat"]').value = lat;
            document.querySelector('[name="recovery_lng"]').value = lng;
            recMarker.on('dragend', () => updateLocation(recMarker, "recovery"));
        }

        setting = null;
        calculateDistance();
    });

    function updateLocation(marker, type) {
        const pos = marker.getLatLng();
        document.querySelector(`[name="${type}_lat"]`).value = pos.lat;
        document.querySelector(`[name="${type}_lng"]`).value = pos.lng;
        calculateDistance();
    }

    function calculateDistance() {
        if (shotMarker && recMarker) {
            const p1 = shotMarker.getLatLng(), p2 = recMarker.getLatLng();
            const R = 3959; // miles
            const dLat = (p2.lat - p1.lat) * Math.PI / 180;
            const dLng = (p2.lng - p1.lng) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 +
                      Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
                      Math.sin(dLng / 2) ** 2;
            const d = 2 * R * Math.asin(Math.sqrt(a)) * 1760; // yards
            document.getElementById("distance_input").value = d.toFixed(1);
        }
    }

    window.addEventListener("DOMContentLoaded", () => {
        weaponSelect.dispatchEvent(new Event("change"));
        caliberSelect.dispatchEvent(new Event("change"));
        broadheadSelect.dispatchEvent(new Event("change"));
    });
    </script>
</body>
</html>
