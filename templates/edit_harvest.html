<!--
EDIT HARVEST.HTML -
- Purpose: Edit an existing harvest with consistent layout (form left, sticky map right)
            Global button styles, seeded map pins, and Save/Cancel row
-->
<!DOCTYPE html>
<html>
<head>
    <title>Edit Harvest</title>
    <!-- Global styles + Leaflet -->
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        /* Page layout matches add/edit sighting */
        .content-wrapper {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 40px;
            gap: 40px;
        }
        .form-section {
            flex: 2;
            min-width: 300px;
            max-width: 600px;
        }
        .map-section {
            flex: 1;
            position: sticky;
            top: 120px;
            align-self: flex-start;
        }
        #map {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-top: 10px;
        }
        /* Simple error list */
        .errors {
            color: red;
            font-size: 0.9rem;
            list-style: none;
            padding: 0;
            margin: 0 0 10px;
        }
        /* Small tool row above the map */
        .map-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        /* Spacing helper for fields */
        .field-spacer {
            margin: 10px 0l
        }
    </style>
</head>
<body>

    <!-- Back-links to match other pages -->
    <nav class="back-links">
        <a href="{{ url_for('view_harvests') }}">← Back to All Harvests</a>
        {% if request.referrer %}<a href="{{ request.referrer }}">← Back to Previous Page</a>{% endif %}
    </nav>

    <h1 style="text-align:center; padding-top:10px;">Edit Harvest</h1>

    <div class="content-wrapper">
        <!-- LEFT: Form -->
        <section class="form-section">
            <form id="harvestForm" method="POST" enctype="multipart/form-data">
                {{ form.hidden_tag() }}

                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <ul class="errors">
                        {% for category, message in messages %}
                            <li>{{ message }}</li>
                        {% endfor %}
                        </ul>
                    {% endif %}
                {% endwith %}

                <!-- Animal -->
                <div class="field-spacer">
                    <label for="animal">Animal:</label>
                    {{ form.animal(id="animal") }}
                    {% if form.animal.errors %}<ul class="errors">{% for e in form.animal.errors %}<li>{{ e }}</li>{% endfor %}</ul>{% endif %}
                </div>

                <br><br>

                <!-- Date/Time -->
                <div class="field-spacer">
                    <label for="date_time">Date &amp; Time:</label>
                    {{ form.date_time(type="datetime-local", id="date_time") }}
                    {% if form.date_time.errors %}<ul class="errors">{% for e in form.date_time.errors %}<li>{{ e }}</li>{% endfor %}</ul>{% endif %}
                </div>

                <br><br>

                <!-- Weapon -->
                <div class="field-spacer">
                    <label for="weapon_select">Weapon Type:</label>
                    {{ form.weapon_type(id="weapon_select") }}
                    {% if form.weapon_type.errors %}<ul class="errors">{% for e in form.weapon_type.errors %}<li>{{ e }}</li>{% endfor %}</ul>{% endif %}
                </div>

                <!-- If other weapon -->
                <div id="other_weapon_div" class="hidden field-spacer">
                    <label>If Other:</label>
                    {{ form.other_weapon_type(disabled=True, class="disabled") }}
                    {% if form.other_weapon_type.errors %}<ul class="errors">{% for e in form.other_weapon_type.errors %}<li>{{ e }}</li>{% endfor %}</ul>{% endif %}
                </div>

                <br>

                <!-- Caliber/Gauge (firearms only) -->
                <div id="caliber_section" class="hidden field-spacer">
                    <label for="caliber_select">Caliber / Gauge:</label>
                    <select id="caliber_select" name="caliber" disabled class="disabled">
                    <option value="">Select caliber/gauge</option>
                    </select>
                    {% if form.caliber.errors %}<ul class="errors">{% for e in form.caliber.errors %}<li>{{ e }}</li>{% endfor %}</ul>{% endif %}
                </div>

                <!-- If other (caliber) -->
                <div id="other_caliber_div" class="hidden field-spacer">
                    <label>If Other:</label>
                    {{ form.other_caliber(disabled=True, class_="disabled") }}
                    {% if form.other_caliber.errors %}<ul class="errors">{% for e in form.other_caliber.errors %}<li>{{ e }}</li>{% endfor %}</ul>{% endif %}
                </div>

                <!-- Broadhead (bows only) -->
                <div id="broadhead_section" class="hidden field-spacer">
                    <label>Broadhead Type:</label>
                    <select id="broadhead_select" name="broadhead" disabled class="disabled"><option value="">Select broadhead</option>
                    <option value="Fixed">Fixed</option>
                    <option value="Mechanical">Mechanical</option>
                    <option value="Hybrid">Hybrid</option>
                    <option value="Other">Other</option>
                    </select>
                    {% if form.broadhead.errors %}<ul class="errors">{% for e in form.broadhead.errors %}<li>{{ e }}</li>{% endfor %}</ul>{% endif %}
                </div>

                <!-- If other (broadhead) -->
                <div id="other_broadhead_div" class="hidden field-spacer">
                    <label>If Other:</label>
                    {{ form.other_broadhead(disabled=True, class_="disabled") }}
                    {% if form.other_broadhead.errors %}<ul class="errors">{% for e in form.other_broadhead.errors %}<li>{{ e }}</li>{% endfor %}</ul>{% endif %}
                </div>

                <br>
                <br>

                <!-- Notes -->
                <div class="field-spacer">
                <label for="notes">Notes:</label>
                {{ form.notes(rows=4, cols=50, id="notes") }}
                {% if form.notes.errors %}<ul class="errors">{% for e in form.notes.errors %}<li>{{ e }}</li>{% endfor %}</ul>{% endif %}
                </div>
                <br>
                <br>

                <!-- Photo -->
                <div class="field-spacer">
                    <label for="photo">Upload Photo:</label>
                    {{ form.photo(id="photoInput") }}
                    <div style="margin-top:8px;">
                    <img id="photoPreview" style="max-width:200px; display:none; border:1px solid #ccc; border-radius:4px;">
                    </div>
                </div>
                <br>
                <br>

                <!-- Save/Cancel row using global styles -->
                <div class="form-actions">
                    <button type="submit" class="btn btn--sm btn-primary">Save Changes</button>
                    <a class="btn btn--sm btn--ghost" href=""
                </div>

                <button type="submit" class="btn">Submit Harvest</button>
            </form>
        </div>

        <div class="map-section"></div>
    </div>

    <!-- Leaflet & Interactivity -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
    const weaponSelect = document.getElementById("weapon_select");
    const caliberSelect = document.getElementById("caliber_select");
    const broadheadSelect = document.getElementById("broadhead_select");

    const caliberSection = document.getElementById("caliber_section");
    const broadheadSection = document.getElementById("broadhead_section");

    const otherWeaponDiv = document.getElementById("other_weapon_div");
    const otherCaliberDiv = document.getElementById("other_caliber_div");
    const otherBroadheadDiv = document.getElementById("other_broadhead_div");

    const weaponOptions = {
        "Rifle": [".223", ".243", ".270", ".30-06", ".308", "7mm", "Other"],
        "Shotgun": ["12 gauge", "20 gauge", "16 gauge", "10 gauge", "Other"],
        "Compound Bow": ["N/A"],
        "Recurve Bow": ["N/A"],
        "Longbow": ["N/A"],
        "Crossbow": ["N/A"]
    };

    const bowTypes = ["Compound Bow", "Recurve Bow", "Longbow", "Crossbow"];

    weaponSelect.addEventListener("change", () => {
        const selected = weaponSelect.value;
        const isBow = bowTypes.includes(selected);

        // Caliber logic - - - - - - - - - - - - - - - - - - - - - - - -
        if (isBow) {
            caliberSection.classList.add("hidden");
            caliberSelect.disabled = true;
            caliberSelect.classList.add("disabled");
        } else {
            caliberSection.classList.remove("hidden");
            caliberSelect.disabled = false;
            caliberSelect.classList.remove("disabled");
            caliberSelect.innerHTML = '<option value="">Select caliber/gauge</option>';
            (weaponOptions[selected] || []).forEach(opt => {
                const o = document.createElement("option");
                o.value = opt;
                o.textContent = opt;
                caliberSelect.appendChild(o);
            });
        }

        // Broadhead logic - - - - - - - - - - - - - - - - - - - - -
        if (isBow) {
            broadheadSection.classList.remove("hidden");
            broadheadSelect.disabled = false;
            broadheadSelect.classList.remove("disabled");
        } else {
            broadheadSection.classList.add("hidden");
            broadheadSelect.disabled = true;
            broadheadSelect.classList.add("disabled");
        }

        // Other weapon field - - - - - - - - - - - - - - - - - - - -
        if (selected === "Other") {
            otherWeaponDiv.classList.remove("hidden");
            otherWeaponDiv.querySelector("input").disabled = false;
            otherWeaponDiv.querySelector("input").classList.remove("disabled");
        } else {
            otherWeaponDiv.classList.add("hidden");
            otherWeaponDiv.querySelector("input").disabled = true;
            otherWeaponDiv.querySelector("input").classList.add("disabled");
        }
    });

    caliberSelect.addEventListener("change", () => {
        const showOther = caliberSelect.value === "Other";
        otherCaliberDiv.classList.toggle("hidden", !showOther);
        otherCaliberDiv.querySelector("input").disabled = !showOther;
        otherCaliberDiv.querySelector("input").classList.toggle("disabled", !showOther);
    });

    broadheadSelect.addEventListener("change", () => {
        const showOther = broadheadSelect.value === "Other";
        otherBroadheadDiv.classList.toggle("hidden", !showOther);
        otherBroadheadDiv.querySelector("input").disabled = !showOther;
        otherBroadheadDiv.querySelector("input").classList.toggle("disabled", !showOther);
    });

    // MAP LOGIC - - - - - - - - - - - - - - - - - - - - - - - - -
    const map = L.map('map').setView([45, -93], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let shotMarker, recMarker;
    let setting = null;

    document.getElementById('btnShot').onclick = () => setting = "shot";
    document.getElementById('btnRecovery').onclick = () => setting = "recovery";

    map.on('click', e => {
        if (!setting) return;
        const { lat, lng } = e.latlng;
        const color = document.getElementById("marker_color_input").value || "#3388ff";
        const icon = L.divIcon({
            className: 'custom-div-icon',
            html: `<div style="background-color:${color}; width:16px; height:16px; border-radius:50%; border:2px solid white;"></div>`,
            iconSize: [16, 16],
            iconAnchor: [8, 8]
        });

        if (setting === "shot") {
            if (shotMarker) map.removeLayer(shotMarker);
            shotMarker = L.marker(e.latlng, { icon, draggable: true }).addTo(map).bindPopup("Shot").openPopup();
            document.querySelector('[name="shot_lat"]').value = lat;
            document.querySelector('[name="shot_lng"]').value = lng;
            shotMarker.on('dragend', () => updateLocation(shotMarker, "shot"));
        }

        if (setting === "recovery") {
            if (recMarker) map.removeLayer(recMarker);
            recMarker = L.marker(e.latlng, { icon, draggable: true }).addTo(map).bindPopup("Recovery").openPopup();
            document.querySelector('[name="recovery_lat"]').value = lat;
            document.querySelector('[name="recovery_lng"]').value = lng;
            recMarker.on('dragend', () => updateLocation(recMarker, "recovery"));
        }

        setting = null;
        calculateDistance();
    });

    function updateLocation(marker, type) {
        const pos = marker.getLatLng();
        document.querySelector(`[name="${type}_lat"]`).value = pos.lat;
        document.querySelector(`[name="${type}_lng"]`).value = pos.lng;
        calculateDistance();
    }

    function calculateDistance() {
        if (shotMarker && recMarker) {
            const p1 = shotMarker.getLatLng(), p2 = recMarker.getLatLng();
            const R = 3959; // miles
            const dLat = (p2.lat - p1.lat) * Math.PI / 180;
            const dLng = (p2.lng - p1.lng) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 +
                      Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
                      Math.sin(dLng / 2) ** 2;
            const d = 2 * R * Math.asin(Math.sqrt(a)) * 1760; // yards
            document.getElementById("distance_input").value = d.toFixed(1);
        }
    }

    window.addEventListener("DOMContentLoaded", () => {
        weaponSelect.dispatchEvent(new Event("change"));
        caliberSelect.dispatchEvent(new Event("change"));
        broadheadSelect.dispatchEvent(new Event("change"));
    });
    </script>
</body>
</html>
